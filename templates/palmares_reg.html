{% extends 'base.html' %}

{% block head %}
<title>Palmarès</title>
{% endblock %}

{% block body %}
<div class="content">


    <div class="description">
        <h4 style="text-align:left;word-wrap:break-word;">Palmares des magasins en France en Euros, de tous les indicateurs, 
            pour toutes les familles de produit, pour toutes les enseignes, pour le mois de {{mois}} {{current_year}}, 
            classés par {{ classement_indicator }}, pour la région {{ region_id }}.</h4>
    </div>


    <div class="filtre">
        <form action={{ "/palmares/" ~ region_id }} method="POST" style="text-align:center;">

            <select 
                style="width:200px;height:30px;margin:5px"
                name="annee" 
                id="year_select"  
                onchange="get_delta()">
                <option value="{{years[0]}}">--Choix de l'année--</option>
                {% for year in years %}
                    <option value="{{year}}">{{year}}</option>
                {% endfor %}
            </select></br>

            <div id="month_select"></div>
            
            <script>
                document.getElementById("year_select").addEventListener("change", get_html_months);
            </script>
    
            <select style="width:200px;height:30px" name="classement" id="mois-select">
                <option value="ca_reel">--Choix de l'indicateur de classement--</option>
                <option value="ca_reel">CA réel</option>
                <option value="ca_objectif">CA objectif</option>
                <option value="vente_reel">Vente réel</option>
                <option value="ventes_objectif">Vente objectif</option>
                <option value="marge_reel">Marge réelle</option>
                <option value="marge_objectif">Marge objectif</option>
            </select></br>
    
            <button class="button" type="submit">Recherche</button>
        </form>
    </div>


    <div class="palmares">

    <table id="palmares_table">
        <tr>
            <th style="border-top-width:0px;border-left-width:0px;border-bottom-width:0px"></th>
            <th colspan="3" bgcolor="#99B4D1"> CA </th>
            <th colspan="3" bgcolor="#99B4D1"> Ventes </th>
            <th colspan="3" bgcolor="#99B4D1"> Marge </th>
            <th rowspan="2" bgcolor="#99B4D1"> Rang National </th>
            <th rowspan="2" bgcolor="#99B4D1"> Rang année précédente National </th>
            <th rowspan="2" bgcolor="#99B4D1"> Evolution National </th>
            <th rowspan="2" bgcolor="#99B4D1"> Rang Régional </th>
            <th rowspan="2" bgcolor="#99B4D1"> Rang année précédente Régional </th>
            <th rowspan="2" bgcolor="#99B4D1"> Evolution Régional </th>
        </tr>

        <tr>
            <th bgcolor="#99B4D1">Ville</th>
            <th bgcolor="#99B4D1">Budget</th><th bgcolor="#99B4D1">Reel</th><th bgcolor="#99B4D1">Ratio</th>
            <th bgcolor="#99B4D1">Budget</th><th bgcolor="#99B4D1">Reel</th><th bgcolor="#99B4D1">Ratio</th>
            <th bgcolor="#99B4D1">Budget</th><th bgcolor="#99B4D1">Reel</th><th bgcolor="#99B4D1">Ratio</th>
        </tr>

        {% for mag in pi %}
            {% if mag[0] in magasins %}
            <tr>
                <th bgcolor="#99B4D1">{{mag[0]}}</th>
                <td> {{ '{0:0.2f}'.format(mag[1]) }}</td>
                <td> {{ '{0:0.2f}'.format(mag[2]) }}</td>

                {% set ratio_CA = mag[2] / mag[1] %}
                {% if ratio_CA < 0 %} 
                    <td bgcolor="red"> {{ '{0:0.2f}'.format(ratio_CA) }}</td>
                {% elif ratio_CA > 0 %} 
                    <td bgcolor="green"> {{ '{0:0.2f}'.format(ratio_CA) }}</td>
                {% else %} 
                    <td bgcolor="yellow"> {{ '{0:0.2f}'.format(ratio_CA) }}</td>
                {% endif %}

                <td> {{ '{0:0.2f}'.format(mag[3]) }}</td>
                <td> {{ '{0:0.2f}'.format(mag[4]) }}</td>

                {% set ratio_ventes = mag[4] / mag[3] %}
                {% if ratio_ventes < 0 %} 
                    <td bgcolor="red"> {{ '{0:0.2f}'.format(ratio_ventes) }}</td>
                {% elif ratio_ventes > 0 %} 
                    <td bgcolor="green"> {{ '{0:0.2f}'.format(ratio_ventes) }}</td>
                {% else %} 
                    <td bgcolor="yellow"> {{ '{0:0.2f}'.format(ratio_ventes) }}</td>
                {% endif %}

                <td> {{ '{0:0.2f}'.format(mag[5]) }}</td>
                <td> {{ '{0:0.2f}'.format(mag[6]) }}</td>

                {% set ratio_marges = mag[6] / mag[5] %}
                {% if ratio_marges < 0 %} 
                    <td bgcolor="red"> {{ '{0:0.2f}'.format(ratio_marges) }}</td>
                {% elif ratio_marges > 0 %} 
                    <td bgcolor="green"> {{ '{0:0.2f}'.format(ratio_marges) }}</td>
                {% else %} 
                    <td bgcolor="yellow"> {{ '{0:0.2f}'.format(ratio_marges) }}</td>
                {% endif %}

                <td> {{ loop.index }}</td>
                <td> {{ rank_prev[mag[0]] }}</td>

                {% set ecart_nat = loop.index - rank_prev[mag[0]] if mag[0] in rank_prev.keys() else loop.index %}
                {% if ecart_nat < 0 %} 
                    <td bgcolor="red"> {{ ecart_nat }}</td>
                {% elif ecart_nat > 0 %} 
                    <td bgcolor="green"> {{ ecart_nat }}</td>
                {% else %} 
                    <td bgcolor="yellow"> {{ ecart_nat }}</td>
                {% endif %}

                <td> {{ rank_reg[mag[0]] }}</td>
                <td> {{ rank_reg_prev[mag[0]] }}</td>

                {% set ecart_reg = rank_reg[mag[0]] - rank_reg_prev[mag[0]] if mag[0] in rank_reg_prev.keys() else rank_reg[mag[0]] %}
                {% if ecart_reg < 0 %} 
                    <td bgcolor="red"> {{ ecart_reg }}</td>
                {% elif ecart_reg > 0 %} 
                    <td bgcolor="green"> {{ ecart_reg }}</td>
                {% else %} 
                    <td bgcolor="yellow"> {{ ecart_reg }}</td>
                {% endif %}

            </tr>
            {% endif %}


            


            
        {% endfor %}

    </table>


    <script>
        document.getElementById('export_button').addEventListener('click', function(){
            var table2excel = new Table2Excel();
            table2excel.export(document.querySelectorAll("#palmares_table"));
        })

    </script>

    </div>



    



</div>
{% endblock %}


